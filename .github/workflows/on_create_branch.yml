name: Create Branch Documentation

on:
  create:
    branches:
      - '**'  

permissions:
  contents: write

jobs:
  convert_csv_and_update_readme:
    if: startsWith(github.ref, 'refs/heads/')
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the new branch that was just created
      - name: Checkout new branch
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.ref }}

      # Step 2: Get the branch name
      - name: Get Branch Name
        id: vars
        run: |
          branch_name="${GITHUB_REF#refs/heads/}"
          echo "branch_name=$branch_name" >> $GITHUB_ENV

      # Step 3: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      # Step 4: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas openpyxl

      # Step 5: Convert CSV to HTML 
      - name: Convert CSV to HTML
        run: |
          html_output_dir="gitBranches/${{ env.branch_name }}/identifiers"
          
          mkdir -p "$html_output_dir"

          python - <<EOF
          import pandas as pd
          import os
          from openpyxl import load_workbook

          # Output directory based on branch name
          html_output_dir = "${html_output_dir}"
  

          # Define files and IDs
          files_with_ids = {
              "ecoinvent database: source data sets": "doc/identifiers/BackgroundDB_SourceDatasets_ecoinvent.csv",
              "GaBi database: source data sets": "doc/identifiers/BackgroundDB_SourceDatasets_GaBi.csv",
              "Common references": "doc/identifiers/Common_references.csv",
              "Country-specific indicators": "doc/identifiers/Country-specific_indicators.csv",
              "EN15804+A1 indicators": "doc/identifiers/EN15804+A1_indicators.csv",
              "EN15804+A2 (EF3.0) indicators": "doc/identifiers/EN15804+A2_EF3.0_indicators.csv",
              "EN15804+A2 (EF3.1) indicators": "doc/identifiers/EN15804+A2_EF3.1_indicators.csv",
              "Flow properties and unit groups": "doc/identifiers/Flow_properties_and_unit_groups.csv"
          }

          # Convert CSV to HTML
          for file_id, file_path in files_with_ids.items():
              if os.path.exists(file_path):
                  df = pd.read_csv(file_path)
                  html_table = df.to_html(index=False, classes='table table-striped', border=0, table_id=file_id)
                  html_filename = os.path.join(html_output_dir, os.path.basename(file_path).replace('.csv', '.html'))
                  with open(html_filename, 'w') as f:
                      f.write(f"""
                      <!DOCTYPE html>
                      <html>
                      <head>
                          <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
                          <title>{file_id}</title>
                      </head>
                      <body>
                          <div class="container">
                              <h1>{file_id}</h1>
                              {html_table}
                          </div>
                      </body>
                      </html>
                      """)


      # Step 6: Checkout the gitActions branch and create directories for schemadoc
      - name: Checkout gitActions branch
        uses: actions/checkout@v2
        with:
          ref: gitActions
          path: gitActions

      - name: Create directories for new branch outputs
        run: |
          mkdir -p gitActions/gitBranches/${{ env.branch_name }}/schemadoc

      - name: Copy Files to gitActions
        run: |
          branch_name="${{ env.branch_name }}"
          cp -r gitBranches/$branch_name gitActions/gitBranches/
          cp -r ./doc/schemadoc/* gitActions/gitBranches/$branch_name/schemadoc/

      # Step 7: Commit and push changes to gitActions branch
      - name: Commit and push changes to gitActions branch
        working-directory: gitActions
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add gitBranches/${{ env.branch_name }}
          git commit -m "Converted CSV files and added schemadoc content for ${{ env.branch_name }}"
          git push origin gitActions

      # Step 8: Clear the content of README.md before updating it
      - name: Clear README.md
        run: |
          echo "" > README.md

      # Step 9: Update the README.md with links to the HTML files
      - name: Update README.md with title and links
        run: |
          branch_name=${{ env.branch_name }}
          readme_path="README.md"
          cat <<EOF > $readme_path
          # ILCD-EPD Data Format Documentation

          Welcome to the ILCD+EPD Data Format documentation. This README provides a comprehensive overview of the format, along with essential links, references, and resources.

          ## ILCD+EPD Guides

          **[ILCD+EPD Data Format Introduction](/doc/guides/ILCD-EPD_Data_Format_Introduction.md)**<br/>
          This document provides an overview of the ILCD+EPD data format, its object-oriented structure, dataset types, and referencing system. It explains how Environmental Product Declarations (EPDs) are modeled and linked, along with API usage for accessing and querying datasets.

          **[Developer Quick Start Guide](/doc/guides/EPD%20Data%20Format%20–%20Developer%20Quick%20Start%20Guide.md)**<br/>
          This document serves as a starting point for software developers who want to integrate support for the ÖKOBAUDAT’s EPD data format and/or data exchange to or from the ÖKOBAUDAT into their software applications.
          
          **[Migration Guide from v1.1 to v1.2](/doc/guides/EPD%20Data%20Format%20–%20Migration%20Guide%20from%201.1%20to%201.2.md)**<br/>
          This document is a migration guide outlining the changes from ILCD+EPD format version 1.1 to 1.2.

          **[Technical Details](/doc/guides/EPD%20Data%20Format%20–%20Technical%20Details.md)**<br/>
          This document provides additional information for software developers who want to integrate support for the ILCD+EPD data format into their software applications.

          ## Schemas
          XML schemas are used to formally describe the XML syntax and data types. They are used to validate instance documents (i.e. ILCD+EPD datasets) and serve as a foundation for generating classes for software applications that read and/or write ILCD+EPD data.

          | Schema Name | Go to Source Code (XSD) | View HTML Documentation in the Browser |
          |-------------|-------------------|-----------------------------------|
          | EPD_DataSet.xsd | [Source Code](./schemas/EPD_DataSet.xsd) | [View Documentation](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/schemadoc/EPD_DataSet.html) |
          | ILCD_FlowDataSet.xsd | [Source Code](./schemas/ILCD_FlowDataSet.xsd) | [View Documentation](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/schemadoc/EPD_FlowDataSet.html) |
          | ILCD_Common_DataTypes.xsd | [Source Code](./schemas/ILCD_Common_DataTypes.xsd ) | [View Documentation](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/schemadoc/ILCD_Common_DataTypes.html) |
          | ILCD_Common_EnumerationValues.xsd | [Source Code](./schemas/ILCD_Common_EnumerationValues.xsd) | [View Documentation](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/schemadoc/ILCD_Common_EnumerationValues.html) |
          | ILCD_ContactDataSet.xsd | [Source Code](./schemas/ILCD_ContactDataSet.xsd) | [View Documentation](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/schemadoc/ILCD_ContactDataSet.html) |
          | ILCD_FlowPropertyDataSet.xsd | [Source Code](./schemas/ILCD_FlowPropertyDataSet.xsd) | [View Documentation](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/schemadoc/ILCD_FlowPropertyDataSet.html) |
          | ILCD_LCIAMethodDataSet.xsd | [Source Code](./schemas/ILCD_LCIAMethodDataSet.xsd) | [View Documentation](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/schemadoc/ILCD_LCIAMethodDataSet.html) |
          | ILCD_LCIAMethodDataSet.xsd | [Source Code](./schemas/ILCD_LCIAMethodDataSet.xsd) | [View Documentation](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/schemadoc/ILCD_SourceDataSet.html) |
          | ILCD_UnitGroupDataSet.xsd | [Source Code](./schemas/ILCD_UnitGroupDataSet.xsd) | [View Documentation](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/schemadoc/ILCD_UnitGroupDataSet.html) |


          ## Authoritative Identifiers (UUIDs)

          The ILCD data format is an object-oriented format (see [ILCD+EPD Data Format Introduction](/doc/guides/ILCD-EPD_Data_Format_Introduction.md)). Some objects are very often reused and have a authoritative character (master data), e.g. for units, LCIA methods, background databases/versions etc. They ensure consistency across datasets.
          Each object has their individual UUID. The most important UUIDs are listed here for reference. You can view or download these lists in CSV format.
          All master data can be found in a dedicated [repository](https://github.com/InDataWG/ILCD-EPD-Master-Data) 

          | Reference Type                         | View HTML in the Browser                         | View CSV Source                              |
          |----------------------------------------|--------------------------------------------------|------------------------------------------------|
          | Common references                      | [View Table](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/identifiers/Common_references.html)     | [Download CSV](./doc/identifiers/Common_references.csv "download")       |
          | Flow properties and unit groups        | [View Table](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/identifiers/Flow_properties_and_unit_groups.html) | [Download CSV](./doc/identifiers/Flow_properties_and_unit_groups.csv "download")|
          | EN15804+A1 indicators                  | [View Table](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/identifiers/EN15804+A1_indicators.html) | [Download CSV](./doc/identifiers/EN15804+A1_indicators.csv "download")|
          | EN15804+A2 (EF3.0) indicators          | [View Table](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/identifiers/EN15804+A2_EF3.0_indicators.html) | [Download CSV](./doc/identifiers/EN15804+A2_EF3.0_indicators.csv "download")|
          | EN15804+A2 (EF3.1) indicators          | [View Table](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/identifiers/EN15804+A2_EF3.1_indicators.html) | [Download CSV](./doc/identifiers/EN15804+A2_EF3.1_indicators.csv "download")|
          | Country-specific indicators            | [View Table](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/identifiers/Country-specific_indicators.html)  | [Download CSV](./doc/identifiers/Country-specific_indicators.csv "download") |
          | ecoinvent database: source data sets   | [View Table](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/identifiers/BackgroundDB_SourceDatasets_ecoinvent.html)  | [Download CSV](./doc/identifiers/BackgroundDB_SourceDatasets_ecoinvent.csv "download")    |
          | GaBi database: source data sets        | [View Table](https://indatawg.github.io/ILCD-EPD-Data-Format/gitBranches/$branch_name/identifiers/BackgroundDB_SourceDatasets_GaBi.html) | [Download CSV](./doc/identifiers/BackgroundDB_SourceDatasets_GaBi.csv "download")  |

          ## Example dataset

          A simple [example ILCD+EPD process dataset](./sample_data/processes/57a4ae65-d305-421e-b21f-a3f0c35b8abe.xml) can be found in the [sample_data](./sample_data) folder of this repository. 


          ## Validation

          ### ILCD Validation Tool

          In order to make sure that a given ILCD+EPD dataset is compliant with both the XML Schemas and the ILCD+EPD master data, it can be validated using the [ILCD Validation Tool](https://bitbucket.org/okusche/ilcdvalidationtool/wiki/Home), a free and Open Source desktop tool available for all major operating systems. You will need to use a validation profile specific for ILCD+EPD (see next subsection).

          For developers, the underlying logic for validating ILCD+EPD data against a given validation profile is also available as an Open Source Java library: [ILCD Validation Library](https://bitbucket.org/okusche/ilcdvalidation/)

          ### Validation profiles

          The generic profile for ILCD+EPD v1.2 for EN 15804+A1 and +A2 (EF3.0 and EF3.1) compliant data is available [here](https://repo1.maven.org/maven2/com/okworx/ilcd/validation/profiles/EPD-1.2-Generic-EN15804/2.2.0/EPD-1.2-Generic-EN15804-2.2.0.jar).

          The profile with additionl specific rules for the [ÖKOBAUDAT](https://www.oekobaudat.de/) database is available [here](https://repo1.maven.org/maven2/com/okworx/ilcd/validation/profiles/EPD-1.2-OEKOBAUDAT/3.5.0/EPD-1.2-OEKOBAUDAT-3.5.0.jar).

                    
      # Step 10: Commit and push the updated README.md to the new branch
      - name: Commit and push updated README.md
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Added links to HTML documentation for ${{ env.branch_name }}"
          git push origin ${{ env.branch_name }}
